%%{init: {"securityLevel": "loose", "flowchart": {"htmlLabels": true}}}%%
flowchart TB
    %% 数据流概览图
    subgraph "数据源"
        UserInput[用户输入<br/>键盘/鼠标]
        FileSystem[文件系统<br/>本地文件]
        Network[网络资源<br/>AI API/网络]
        SystemProcess[系统进程<br/>命令输出]
        Configuration[配置文件<br/>JSON/TOML]
    end

    subgraph "数据输入流程"
        UIInput[UI组件输入]
        FileRead[文件读取]
        NetworkRequest[网络请求]
        ProcessOutput[进程输出]
        ConfigLoad[配置加载]
    end

    subgraph "数据处理层"
        FrontendProcess[前端处理<br/>Vue组件逻辑]
        BackendProcess[后端处理<br/>Rust服务]
        Validation[数据验证<br/>格式检查]
        Transformation[数据转换<br/>序列化/反序列化]
        BusinessLogic[业务逻辑<br/>应用规则]
    end

    subgraph "数据存储"
        MemoryStore[内存存储<br/>Pinia状态]
        LocalStorage[本地存储<br/>浏览器存储]
        Database[(SQLite数据库)]
        ConfigFiles[配置文件<br/>持久化]
        Cache[缓存<br/>临时数据]
    end

    subgraph "数据输出"
        UIRender[UI渲染<br/>组件更新]
        FileWrite[文件写入<br/>保存更改]
        NetworkResponse[网络响应<br/>API调用]
        ProcessInput[进程输入<br/>命令执行]
        ConfigSave[配置保存<br/>更新配置]
    end

    subgraph "数据消费者"
        UserView[用户界面<br/>可视化]
        ExternalAPI[外部API<br/>AI服务等]
        SystemCommands[系统命令<br/>终端执行]
        OtherApps[其他应用<br/>文件交互]
        Logging[日志系统<br/>调试监控]
    end

    %% 具体数据流示例

    subgraph "示例1：用户保存文件"
        UserEdit[用户编辑代码] --> EditorContent[编辑器内容]
        EditorContent --> SaveTrigger[保存触发<br/>Ctrl+S或按钮]
        SaveTrigger --> FrontendValidation[前端验证<br/>格式检查]
        FrontendValidation --> TauriIPC[Tauri IPC调用]
        TauriIPC --> BackendValidation[后端验证<br/>路径权限]
        BackendValidation --> FileOperation[文件操作<br/>写入磁盘]
        FileOperation --> SuccessResponse[成功响应]
        SuccessResponse --> UIUpdate[UI更新<br/>保存状态]
        UIUpdate --> UserFeedback[用户反馈<br/>成功提示]
    end

    subgraph "示例2：AI聊天流程"
        UserMessage[用户消息输入] --> MessageFormat[消息格式化]
        MessageFormat --> ModelSelection[模型选择]
        ModelSelection --> APIRequest[API请求构建]
        APIRequest --> NetworkCall[网络调用<br/>AI服务]
        NetworkCall --> StreamResponse[流式响应]
        StreamResponse --> MessageParse[消息解析]
        MessageParse --> DisplayRender[显示渲染<br/>Markdown]
        DisplayRender --> HistorySave[历史保存]
        HistorySave --> DatabaseSave[数据库存储]
    end

    subgraph "示例3：终端命令执行"
        TerminalInput[终端命令输入] --> CommandParse[命令解析]
        CommandParse --> ProcessSpawn[进程创建]
        ProcessSpawn --> StdoutRead[标准输出读取]
        StdoutRead --> OutputFormat[输出格式化]
        OutputFormat --> TerminalDisplay[终端显示]
        TerminalDisplay --> LogStorage[日志存储]
        StdoutRead --> StderrRead[标准错误读取]
        StderrRead --> ErrorHandling[错误处理]
    end

    subgraph "示例4：配置管理流程"
        SettingsChange[设置更改] --> ValidationCheck[验证检查]
        ValidationCheck --> ConfigUpdate[配置更新]
        ConfigUpdate --> Persistence[持久化存储]
        Persistence --> ConfigReload[配置重载]
        ConfigReload --> AppStateUpdate[应用状态更新]
        AppStateUpdate --> UIReRender[UI重新渲染]
    end

    %% 核心数据流连接
    UserInput --> UIInput
    FileSystem --> FileRead
    Network --> NetworkRequest
    SystemProcess --> ProcessOutput
    Configuration --> ConfigLoad

    UIInput --> FrontendProcess
    FileRead --> BackendProcess
    NetworkRequest --> BackendProcess
    ProcessOutput --> BackendProcess
    ConfigLoad --> BackendProcess

    FrontendProcess --> Validation
    BackendProcess --> Validation
    Validation --> Transformation
    Transformation --> BusinessLogic

    BusinessLogic --> MemoryStore
    BusinessLogic --> LocalStorage
    BusinessLogic --> Database
    BusinessLogic --> ConfigFiles
    BusinessLogic --> Cache

    MemoryStore --> UIRender
    LocalStorage --> UIRender
    Database --> UIRender
    ConfigFiles --> ConfigSave
    Cache --> NetworkResponse

    UIRender --> UserView
    FileWrite --> FileSystem
    NetworkResponse --> ExternalAPI
    ProcessInput --> SystemCommands
    ConfigSave --> Configuration

    %% 双向数据流
    UserView <--> UserInput
    FileSystem <--> FileRead
    ExternalAPI <--> Network
    SystemCommands <--> SystemProcess
    Configuration <--> ConfigLoad

    %% 样式定义
    classDef source fill:#e1f5fe,stroke:#01579b
    classDef input fill:#f3e5f5,stroke:#4a148c
    classDef process fill:#e8f5e8,stroke:#1b5e20
    classDef storage fill:#fff3e0,stroke:#e65100
    classDef output fill:#fce4ec,stroke:#880e4f
    classDef consumer fill:#e1f5fe,stroke:#01579b,stroke-dasharray:5 5
    classDef example fill:#f0f4c3,stroke:#827717

    class UserInput,FileSystem,Network,SystemProcess,Configuration source
    class UIInput,FileRead,NetworkRequest,ProcessOutput,ConfigLoad input
    class FrontendProcess,BackendProcess,Validation,Transformation,BusinessLogic process
    class MemoryStore,LocalStorage,Database,ConfigFiles,Cache storage
    class UIRender,FileWrite,NetworkResponse,ProcessInput,ConfigSave output
    class UserView,ExternalAPI,SystemCommands,OtherApps,Logging consumer

    class UserEdit,EditorContent,SaveTrigger,FrontendValidation,TauriIPC,BackendValidation,FileOperation,SuccessResponse,UIUpdate,UserFeedback example
    class UserMessage,MessageFormat,ModelSelection,APIRequest,NetworkCall,StreamResponse,MessageParse,DisplayRender,HistorySave,DatabaseSave example
    class TerminalInput,CommandParse,ProcessSpawn,StdoutRead,OutputFormat,TerminalDisplay,LogStorage,StderrRead,ErrorHandling example
    class SettingsChange,ValidationCheck,ConfigUpdate,Persistence,ConfigReload,AppStateUpdate,UIReRender example